var authFunctionality={enabled:!0,debug:!1,init:function(e){var t=this;t.enable=!window.location.href.indexOf("extra=false")>-1,t.debug=window.location.href.indexOf("debug=true")>-1,t.hostname="."+window.location.hostname,t.secure="https:"===window.location.protocol,t.log("state debug="+t.debug+" enable="+t.enable),e?(t.log("started with FB config "+JSON.stringify(e)),t.enable?(t.log("lib enabled"),firebase.initializeApp(e),t.log("firebase init'd"),t.checkUserState().then(function(e){if(e){var n=Cookies.get("auth");if(n){var o=t.parseJwt(n);t.updateAuthCookie().then(function(){Date.now().valueOf()/1e3<o.exp||(t.log("Token is expired. Refreshing and reloading window..."),window.location.reload(!0))})}else t.updateAuthCookie();setInterval(function(){firebase.auth().currentUser.getIdToken(!0).then(function(e){t.log("running firebase token refresh..."),t.updateAuthCookie()})},33e5)}}),this.attachHandlers()):t.log("lib disabled")):t.log(" could not be started, please ensure fb config is used to init")},login:function(e,t){var n=e.val().toLowerCase(),o=t.val(),r=this;jQuery(".form-message").remove();var i=jQuery('<div class="form-message error"><p>'+auth.s.incorrectLoginMessage+"</p></div>"),a=jQuery('<div class="form-message error">'+auth.s.generalErrorMessage+"</div>"),c=e.closest("form");!function(e,t,n){r.callApi("/auth/token",{userName:e,password:t},function(e,t){n(e,null==t?null:t.token)})}(n,o,function(e,t){e?(401==e.status?c.prepend(i):c.prepend(a),r.endActivity(),r.log("dd-api called with error="+e)):function(e,t){firebase.auth().setPersistence(0==jQuery("input[name=ckdc_rememberme]").prop("checked")?firebase.auth.Auth.Persistence.SESSION:firebase.auth.Auth.Persistence.LOCAL).then(function(){return firebase.auth().signInWithCustomToken(e).then(function(e){t(!0)}).catch(function(e){var n=e.message;r.log(n),t(!1)})}).catch(function(e){var n=e.message;r.log(n),t(!1)})}(t,function(e){e?r.actionWhenLogin():(c.prepend(i),r.endActivity()),r.log("login success="+e)})})},log:function(e){this.debug&&console.log("EXTRA: "+e)},getUrlParameter:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===t?"":decodeURIComponent(t[1].replace(/\+/g," "))},actionWhenLogin:function(){var e=this;firebase.auth().onAuthStateChanged(function(t){t&&(e.log("login state handled"),t.getIdTokenResult().then(function(t){e.deleteCookieAndLocalStorage(),0==jQuery("input[name=ckdc_rememberme]").prop("checked")&&localStorage.setItem("REMEMBER_ME",!1);var n=!Cookies.get("auth");if(Cookies.set("auth",t.token,{domain:e.hostname,secure:e.secure,expires:"false"==localStorage.getItem("REMEMBER_ME")?void 0:365}),e.log("auth cookie set redirect="+n),n&&!e.debug){e.log("Reloading window because of login");var o=e.getUrlParameter("redirect_to");o?window.location.href=o:window.location.reload(!0)}}))})},parseJwt:function(e){var t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(atob(t).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(n)},updateAuthCookie:function(){var e=this;return new Promise(function(t,n){firebase.auth().onAuthStateChanged(function(n){n?(e.log("login state handled and status is updated"),n.getIdTokenResult().then(function(n){Cookies.set("auth",n.token,{domain:e.hostname,secure:e.secure,expires:"false"==localStorage.getItem("REMEMBER_ME")?void 0:365}),t(!0)})):t(!1)})})},checkUserState:function(){return new Promise(function(e,t){return firebase.auth().onAuthStateChanged(function(t){e(!!t)})})},partialSignUp:function(e,t){var n=e.val().toLowerCase(),o=t.val(),r=this,i={firstName:ckdc.NAME_PLACEHOLDER,lastName:ckdc.NAME_PLACEHOLDER,email:n,password:o,taxResidence:"",country:"",communicationPrefs:{subscribeMemberEmails:!1,subscribeNewsletterEmails:!1}};jQuery(".kd-box-warning").remove(),r.callApiForGraphQl("mutation { createUser(user:@) {token} }",i,function(n,o){if(n){r.endActivity(),r.log("create user failed "+JSON.stringify(n));var i=n.some(function(e){return e.message.indexOf("email already registered")>-1}),a=jQuery('<div class="kd-box kd-box-warning">'+auth.s.generalErrorMessage+"</div>");i&&(a=jQuery('<div class="kd-box kd-box-warning">'+auth.s.isConflictMessage+"</div>")),e.parent().prepend(a)}else r.login(e,t)})},logout:function(){var e=this;return e.log("logout initiated"),new Promise(function(t,n){firebase.auth().signOut().then(function(){return ckdc.logout_nonce&&jQuery.getJSON(ckdc.ajaxurl,{action:"auth_logout",logout_nonce:ckdc.logout_nonce}).done(function(t){t.success&&e.log(t.message)}),e.deleteCookieAndLocalStorage(),e.log("Logged out user"),t(!0)}).catch(function(n){return e.log(n),t(!1)})})},deleteCookieAndLocalStorage:function(){Cookies.remove("auth",{domain:this.hostname,secure:this.secure}),window.localStorage.removeItem("DIETDOCTOR_USERID"),window.localStorage.removeItem("DIETDOCTOR_LEGACY_USERID"),window.localStorage.removeItem("DIETDOCTOR_USER_INFO"),window.localStorage.removeItem("DIETDOCTOR_TOKEN"),window.localStorage.removeItem("REMEMBER_ME")},callApiForGraphQl:function(e,t,n){function o(e){if("object"!==_typeof(e)||Array.isArray(e))return JSON.stringify(e);var t=Object.keys(e).map(function(t){return"".concat(t,":").concat(o(e[t]))}).join(",");return"{".concat(t,"}")}if(_typeof(t)==Array)for(var r in t)e=e.replace("@",o(t[r]));else e=e.replace("@",t?o(t):"");e='{"query":"'+e.replace(/"/g,'\\"')+'"}',this.callApi("/v1",e,function(e,t){t?n(t.errors,t.data):n([{message:"500"}],null)})},callApi:function(e,t,n){var o=this;fetch(ckdc.DDAPI+e,{method:"POST",headers:{Accept:"application/json","Content-type":"application/json; charset=utf-8"},mode:"cors",body:"string"==typeof t?t:JSON.stringify(t)}).then(function(e){return e.ok?e.json():n(e,null)}).then(function(e){return n(null,e)}).catch(function(e){return o.endActivity(),n(e,null)})},valid:function(e,t){var n=e.parent();n.find(".error-msg").remove(),n.removeClass("error");var o=e[0].checkValidity();return o||(this.log(e.html()+" contains "+e.val()),this.log("Failed validation"),n.append('<div class="error-msg">'+t+"</div>"),n.addClass("error")),o},attachHandlers:function(){var e=this;!function(){function t(t){var n=jQuery(t.target).closest("form"),o=n.find("input[name=ckdc_email]"),r=n.find("input[name=ckdc_password]");return e.log("modal login clicked"),e.valid(o,ckdc.s.login_empty_email)&&e.valid(r,ckdc.s.login_empty_password)&&(e.startActivity(jQuery("button[name=login]")),e.logout().then(function(){e.login(o,r)})),!1}jQuery("button[name=login]").on("click",function(e){return e.preventDefault(),t(e)}),jQuery("form.logins").on("keypress",function(e){if(13==e.which)return e.preventDefault(),t(e)})}(),function(){var t=jQuery("#_form_checkout-account_submit"),n=jQuery("#_form_checkout-account-user_email"),o=jQuery("#_form_checkout-account-user_pass"),r=jQuery("#_form_checkout-account");n.attr("required",!0),o.attr("required",!0);var i=jQuery('<button type="button" id="_form_checkout-account_submit" class="btn form-btn btn-submit dd-member-signup-checkout-account gold ckdc-start-working">'+auth.s.continue+"</button>");function a(){e.log("Signup triggered");var t=e.valid(n,ckdc.s.login_empty_email),r=e.valid(o,ckdc.s.login_empty_password);return!(!t||!r||(e.startActivity(jQuery("#_form_checkout-account_submit")),e.logout().then(function(){e.partialSignUp(n,o)}),1))}t.replaceWith(i),r.attr("onsubmit","return false"),i.on("click",function(e){return e.preventDefault(),a()}),r.on("keypress",function(e){if(13==e.which)return e.preventDefault(),a()})}(),jQuery("#menu-logout-link").on("click",function(t){t.preventDefault(),e.logout().then(function(){e.log("Should logout and reload window now"),e.debug||window.location.reload(!0)})})},startActivity:function(e){this.endActivity();var t=jQuery('<i class="fa fa-spinner" data-spinner aria-hidden="true" style="animation: spin 1s linear infinite;"></i><style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}</style>');e.data("text",e.html()),e.html(t),e.prop("disabled",!0)},endActivity:function(){jQuery("[data-spinner]").each(function(e,t){var n=(t=jQuery(t)).parent();n.html(n.data("text")),n.prop("disabled",!1),t.remove()})}};ckdc.ready(function(){jQuery.getJSON("/wp-content/themes/ckdc/src/js/fb/config.json",function(e){authFunctionality.init(e)})});
//# sourceMappingURL=extra.min.js.map
